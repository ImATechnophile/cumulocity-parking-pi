/* devicemanagement_aclManagement 8.21.0 2018-01-30T22:08:28+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
!function(){"use strict";function e(e,n){function s(e,n,s,i){var r=n.deviceId||n.groupId;return i.isDynamicGroupForId(r).then(function(n){return!n&&(s.getFlag("deprecated")||e.invoke(t,{},{moId:r}))})}function t(e,n,s,i){var r={pageSize:1e3},a=t._cachedRequests;return a||(a=e.all([n.listAll(),s.list(r)]).then(_.flatten),t._cachedRequests=a),a.then(function(e){return _.some(e,function(e){return _.get(e,"devicePermissions."+i)})})}s.$inject=["$injector","$routeParams","c8yBase","c8yDynamicGroups"],t.$inject=["$q","c8yUser","c8yUserGroup","moId"];var i=function(e,n,s,t){e.device={},t.detailCached(n.deviceId||n.groupId).then(s.getResData).then(function(n){e.device=n})};i.$inject=["$scope","$routeParams","c8yBase","c8yInventory"],_.forEach(["/group/:groupId","/device/:deviceId"],function(t){e.when(t,{templateUrl:"devicemanagement_aclManagement/views/index.html",icon:"shield",name:n("Permissions"),controller:i,showIf:s,showIfPermissions:{allRoles:["ROLE_USER_MANAGEMENT_READ"]}})})}e.$inject=["c8yViewsProvider","gettext"],angular.module("c8y.aclManagement",["c8y.parts.aclManagement"]).config(e)}(),angular.module("c8y.aclManagement").controller("aclManagementCtrl",["$scope","$q","c8yBase","c8yUser","c8yUserGroup","c8yAlert","gettext","gettextCatalog",function(e,n,s,t,i,r,a,o){"use strict";function c(){e.user={},e.permission={},e.permission.type=null,e.permission.scope=null,e.permission.access=null,e.permission.source=null,e.sourceType=j.GROUP,e.addPermission=!0,l()}function l(){t.current().then(function(n){e.allowEdit=t.hasRole(n,"ROLE_USER_MANAGEMENT_ADMIN")})}function u(e){return e&&null!==e&&""!==e}function d(e){return u(e.source)&&u(e.scope)&&u(e.type)&&u(e.access)}function p(n){delete e.permission.source,n===j.GROUP?e.sources=e.groups:e.sources=e.users}function m(e){return[e.scope.value,e.type,e.access.value].join(":")}function h(e){var n=e.split(":");return{scope:{value:n[0]},type:n[1],access:{value:n[2]}}}function g(e){i.save(e).then(_.partial(r.success,a("Permissions successfully updated"))).then(P).then(y)}function v(e){delete e.name,t.save(e).then(_.partial(r.success,a("Permissions successfully updated"))).then(b).then(y)}function f(n){var s=n.source,t=s.devicePermissions[e.device.id]||[];s.devicePermissions[e.device.id]=_.union(t,[m(n)]),e.sourceType===j.GROUP?g(s):v(s)}function y(){c()}function b(){var n=t.listAll();n.then(function(n){e.users=n,_.forEach(n,function(e){e.name=e.id})}),k(n).then(function(n){e.userPermissions=n})}function P(){var n=i.list(O);n.then(function(n){e.sources=e.groups=n}),k(n).then(function(n){e.groupPermissions=n})}function w(e){return"*"===e?o.getString("Read and write"):"ADMIN"===e?o.getString("Write"):o.getString("Read")}function R(e){return"*"===e?o.getString("all types of objects"):"MANAGED_OBJECT"===e?$(e):$(e)+"s"}function $(e){return e.toLowerCase().replace("_"," ")}function x(e){return"*"===e&&(e=o.getString("any")),e}function E(e){var n=e.split(":");return[o.getString(n[0]),n[1],o.getString(n[2])].join(":")}function A(n){n&&t.getDevicePermissions(n,e.device.id).then(s.getResData).then(_.partialRight(_.map,h)).then(function(n){e.permissions=n})}function S(e){_.isObjectLike(e)&&_.keys(e).length>0&&(b(),P())}function k(e){return e.then(_.partialRight(_.map,G))}function G(n){return{source:n,permissions:n.devicePermissions[e.device.id]||[]}}function M(){e.addPermission=!e.addPermission}function T(n){e.sourceType=n}function U(n,s){n[e.device.id]=_.filter(n[e.device.id],function(e){return e!==s})}function I(e,n,s){var t=e.source;U(t.devicePermissions,n),s(t)}function C(e,n,s){var t=(e||{}).permissions;return t&&t.length}var O={},j=s.createEnum([a("GROUP"),a("USER")]);e.emptyPermission=C,e.toggleAddPermission=M,e.sourceTypes=j.values(),e.setSourceType=T,e.create=f,e.cancel=y,e.isValid=d,e.humanizeScope=R,e.humanizeAccess=w,e.humanizeFragment=x,e.translatePermission=E,e.removeGroupPermission=_.partialRight(I,g),e.removeUserPermission=_.partialRight(I,v),e.helpText=a("Check user permissions section allows you to verify permissions granted to selected user for the device also inherited from parent devices or assinged to user group. Granted permission section allows you to check and manage permissions for the device."),e.$watch("user.selected",A),e.$watch("device",S),e.$watch("sourceType",p),c()}]),function(){"use strict";function e(e){var n;n='<div ng-controller="aclManagementCtrl">\n    <div class="navbar">\n        <div class="nav navbar-right">\n            <form class="navbar-form">\n                <span class="btn-link" style="text-decoration:none" data-uib-popover="{{helpText | translate}}" data-popover-placement="bottom" data-popover-trigger="mouseenter">\n                    <i c8y-icon="question-circle"></i>\n                </span>\n                <a href="" class="btn btn-link" ng-show="allowEdit" ng-click="toggleAddPermission()">\n                    <i c8y-icon="plus"></i> {{\'Add permission\' | translate}}\n                </a>\n            </form>\n        </div>\n    </div>\n\n    <div class="alert alert-warning">\n      <i c8y-icon="exclamation-triangle" class="fa-2x pull-left"></i>\n      <span translate>\n        This feature is deprecated. Although it\'s still fully functional you should rather use new <a href="/apps/administration#roles">Roles</a> feature to set permissions.\n      </span>\n    </div>\n    <div class="panel panel-clean" uib-collapse="addPermission">\n        <div class="panel-heading">\n            <i c8y-icon="key"></i> {{\'New permission\' | translate}}\n        </div>\n        <form role="form" name="newPermission" class="panel-body" novalidate>\n            <div class="row">\n                <div class="form-group col-lg-3">\n                    <label style="text-transform: capitalize" class="control-label">\n                        {{sourceType.value | translate}}\n                    </label>\n                    <ui-select ng-model="permission.source" class="form-control">\n                        <ui-select-match placeholder="{{\'Select or search\' | translate}}">{{$select.selected.name}}</ui-select-match>\n                        <ui-select-choices repeat="item in sources | filter: $select.search | orderBy:\'name\'">\n                            <div ng-bind-html="item.name | highlight: $select.search"></div>\n                        </ui-select-choices>\n                    </ui-select>\n                    <div class="btn-group pull-left">\n                        <button ng-repeat="type in sourceTypes" class="btn btn-primary" ng-class="{active: sourceType == type}" style="text-transform: capitalize" ng-click="setSourceType(type)">\n                            {{type.value | translate | lowercase}}\n                        </button>\n                    </div>\n                </div>\n                <c8y-device-permission data-scope="permission.scope" data-permission-type="permission.type" data-access="permission.access" data-device="device">\n                </c8y-device-permission>\n            </div>\n\n            <div class="pull-right">\n                <button class="btn btn-primary" ng-click="create(permission)" ng-disabled="!isValid(permission)" translate>Save</button>\n                <button class="btn btn-default" ng-click="cancel()" translate>Cancel</button>\n            </div>\n        </form>\n    </div>\n\n    <div class="panel panel-clean">\n        <div class="panel-heading">\n            <i c8y-icon="user"></i> {{\'Check user permission\' | translate}}\n        </div>\n\n        <div class="panel-body">\n            <div>\n                <label translate>User </label>\n                <ui-select ng-model="user.selected" class="form-control" style="width: 300px">\n                    <ui-select-match placeholder="{{\'Select or search user\' | translate}}">{{$select.selected.id}}</ui-select-match>\n                    <ui-select-choices repeat="item in users | filter: $select.search | orderBy:\'id\'" position="bottom">\n                        <div ng-bind-html="item.id | highlight: $select.search"></div>\n                    </ui-select-choices>\n                </ui-select>\n            </div>\n            <div class="alert alert-warning" data-ng-show="permissions.length == 0" translate>\n                No permissions for user.\n            </div>\n            <table class="table table-hover" ng-show="permissions.length">\n                <tr>\n                    <th translate>Has right to </th>\n                </tr>\n                <tbody>\n                    <tr ng-repeat="permission in permissions">\n                        <td>\n                          {{humanizeAccess(permission.access.value)}}\n                          <strong>{{humanizeScope(permission.scope.value)}}</strong>\n                          {{\'with\' | translate}}\n                          <strong>{{humanizeFragment(permission.type)}}</strong>\n                          {{\'fragment\' | translate}}\n                        </td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n    </div>\n    <div class="panel panel-clean">\n        <div class="panel-heading">\n            <i c8y-icon="shield"></i> {{\'Granted permission\' |translate}}\n        </div>\n\n        <table class="table table-permissions panel-body">\n            <thead>\n                <tr>\n                    <th translate>User</th>\n                    <th translate>Permissions</th>\n                    <th>&nbsp;</th>\n                </tr>\n            </thead>\n            <tbody ng-repeat="userPermission in userPermissions">\n                <tr ng-repeat="permission in userPermission.permissions track by $index">\n                    <td ng-if="$first" style="width: 200px" rowspan="{{userPermission.permissions.length}}">\n                        {{userPermission.source.id}}\n                    </td>\n                    <td>\n                        {{translatePermission(permission)}}\n                    </td>\n                    <td class="text-right">\n                        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Remove permission\' | translate}}" ng-show="allowEdit" ng-click="removeUserPermission(userPermission, permission)"><i c8y-icon="times"></i></button>\n                    </td>\n                </tr>\n            </tbody>\n            <thead>\n                <tr>\n                    <th translate>Group</th>\n                    <th translate>Permissions</th>\n                    <th>&nbsp;</th>\n                </tr>\n            </thead>\n            <tbody ng-repeat="groupPermission in groupPermissions">\n                <tr ng-repeat="permission in groupPermission.permissions track by $index">\n                    <td ng-if="$first" style="width: 200px" rowspan="{{groupPermission.permissions.length}}">\n                        {{groupPermission.source.name}}\n                    </td>\n                    <td>\n                        {{translatePermission(permission)}}\n                    </td>\n                    <td class="text-right">\n                        <button class="btn btn-danger btn-xs showOnHover" title="{{\'Remove permission\' | translate}}" ng-show="allowEdit" ng-click="removeGroupPermission(groupPermission, permission)"><i c8y-icon="times"></i></button>\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </div>\n</div>\n',e.put("devicemanagement_aclManagement/views/index.html",n),e.put("/apps/devicemanagement/aclManagement/views/index.html",n)}angular.module("c8y.aclManagement").run(["$templateCache",e])}();