/* core_alarmsEventsExplorer 8.21.0 2018-01-30T22:07:41+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
!function(){"use strict";angular.module("c8y.alarmsEventsExplorer",[])}(),function(){"use strict";function e(e,t,n,r,a,i){function l(e){var t=!1;e.dateFrom&&(t=c(p.timeline.dateFrom,e.dateFrom.currentValue),p.timeline.dateFrom=_.clone(e.dateFrom.currentValue)),e.dateTo&&(t=c(p.timeline.dateTo,e.dateTo.currentValue),p.timeline.dateTo=_.clone(e.dateTo.currentValue)),e.chartBox&&(p.timeline.chartBox=_.clone(e.chartBox.currentValue)),t?E():o()}function s(){var e=!1;_.isEqual(g,p.alarmsEventsConfigs)||(g=_.cloneDeep(p.alarmsEventsConfigs),e=!0),moment(p.timeline.dateFrom).isSame(p.dateFrom)||(e=c(p.timeline.dateFrom,p.dateFrom),p.timeline.dateFrom=_.clone(p.dateFrom)),moment(p.timeline.dateTo).isSame(p.dateTo)||(e=c(p.timeline.dateTo,p.dateTo),p.timeline.dateTo=_.clone(p.dateTo)),e?E():o()}function o(){e.$broadcast("c8yTimelinesChart::render")}function c(e,t){if(!e||!t)return!1;var n=moment(t).diff(e,"seconds"),r=n<h;return!(p.realtime&&r)}function m(){var e={dateFrom:moment(p.dateFrom).format(n.dateFullFormat),dateTo:moment(p.dateTo).format(n.dateFullFormat),withTotalPages:!0,pageSize:1e3};return i.fetchTimelinesForAlarmsEvents(g,e).then(function(e){T(p.dateFrom,p.dateTo,e)})}function d(e,t,n){_.assign(p.timeline,{dateFrom:_.clone(e),dateTo:_.clone(t),timelines:n})}function u(e){_.forEach(g,function(t,n){i.alarmMatchesConfig(e,t)&&i.transformAlarmToTimelineEvent(e).then(function(e){var t=p.timeline.timelines[n].events,r=_.findIndex(t,{id:e.id});r===-1?t.push(e):t[r]=e})})}function v(e){_.forEach(g,function(t,n){i.eventMatchesConfig(e,t)&&i.transformEventToTimelineEvent(e).then(function(e){var t=p.timeline.timelines[n].events,r=_.findIndex(t,{id:e.id});r===-1?t.push(e):t[r]=e})})}function f(){E()}var p=this,g=[],h=2,y={dateFrom:"",dateTo:"",timelines:[]},E=_.throttle(m,300,{leading:!1,trailing:!0}),T=_.throttle(d,300);_.assign(p,{$onChanges:l,$doCheck:s,onRealtimeAlarm:u,onRealtimeEvent:v,updateDatesAndFetchData:f,timeline:y})}e.$inject=["$scope","$q","c8yBase","c8yAlarms","c8yEvents","c8yAlarmsEventsTimelinesChartService"],angular.module("c8y.alarmsEventsExplorer").component("c8yAlarmsEventsTimelinesChart",{bindings:{alarmsEventsConfigs:"<",dateFrom:"<",dateTo:"<",realtime:"<",chartBox:"<",onRealtimeAlarm:"=?",onRealtimeEvent:"=?",onUpdateDates:"&",updateDatesAndFetchData:"=?",onSizeChanged:"&"},templateUrl:"core_alarmsEventsExplorer/alarmsEventsTimelinesChart/alarmsEventsTimelinesChart.html",controller:e,controllerAs:"vm"})}(),function(){"use strict";function e(e,t,n,r,a,i,l,s){function o(t){return e.all([c(t),m(t)]).then(_.flatten).then(d)}function c(e){var t={source:e.id||e,pageSize:10};return i.list(t).then(function(e){return _.map(e,function(e){return{__active:!1,__target:_.pick(e.source,"id","name"),label:e.type,color:x(),timelineType:F.ALARM.value,filters:{type:e.type}}})})}function m(e){var t={source:e.id||e,pageSize:10};return l.list(t).then(function(e){return _.map(e,function(e){return{__active:!1,__target:_.pick(e.source,"id","name"),label:e.type,color:x(),timelineType:F.EVENT.value,filters:{type:e.type}}})})}function d(e){return _.uniqBy(e,function(e){return[e.__target.id,e.timelineType,e.filters.type].join(":")})}function u(e){return{__active:!1,__target:_.pick(e,"id","name"),label:"",color:x(),timelineType:F.ALARM.value,filters:{type:""}}}function v(t,n){return e.all(_.map(_.filter(t,{__active:!0}),function(e){return f(e,n).then(_.partial(h,e))}))}function f(t,n){var r=e.when([]),a=_.assign({},n,t.filters,{source:t.__target.id});return t.timelineType===F.EVENT.value?r=p(t,a):t.timelineType===F.ALARM.value&&(r=g(t,a)),r}function p(t,n){return l.list(n).then(function(t){return e.all(_.map(t,C))})}function g(t,n){var r=_.assign({},n,{dateFrom:moment(0).format(a.dateFullFormat),dateTo:n.dateFrom,revert:!0,pageSize:1}),l=n,s=_.assign({},n,{dateFrom:n.dateTo,dateTo:moment().format(a.dateFullFormat),pageSize:1}),o=[i.list(r),i.list(l),i.list(s)];return e.all(o).then(_.flatten).then(function(t){return e.all(_.map(t,T))})}function h(e,t){return{label:e.label,color:e.color,events:t}}function y(e,t){return _.isMatch(t,{timelineType:"ALARM",__target:{id:e.source.id},filters:{type:e.type}})}function E(e,t){return _.isMatch(t,{timelineType:"EVENT",__target:{id:e.source.id},filters:{type:e.type}})}function T(t){return e.all([i.alarmDurationDiff(t),b(t)]).then(function(e){var n=e[0],r=e[1],l=t.firstOccurrenceTime||t.time||t.creationTime,s=t.status!==i.status.ACTIVE&&n?moment(l).subtract(n).format(a.dateFullFormat):void 0;return{id:t.id,dateFrom:l,dateTo:s,tooltip:r}})}function b(e){var t=r("absoluteDate"),n=r("translate"),a=r("humanize2");return i.statusText(e).then(function(r){var l=e.firstOccurrenceTime||e.time;return _.flatten(['<i class="fa fw fa-bell"></i> <b>'+t(l)+"</b>",n(s("Status"))+": "+r,_.map(i.getStandardKeys(e),function(t,r){return n(t)+": <b>"+e[r]+"</b>"}),_.map(i.getNonStandardKeys(e),function(t){return a(t)+": <b>"+JSON.stringify(e[t])+"</b>"})]).join("<br />")})}function C(e){return A(e).then(function(t){return{id:e.id,date:e.time,tooltip:t}})}function A(t){var n=r("absoluteDate"),a=r("translate"),i=r("humanize2");return e.when(_.flatten(['<i class="fa fw fa-rss"></i> <b>'+n(t.time)+"</b>",_.map(l.getStandardKeys(t),function(e,n){return a(e)+": <b>"+t[n]+"</b>"}),_.map(l.getNonStandardKeys(t),function(e){return i(e)+": <b>"+JSON.stringify(t[e])+"</b>"})]).join("<br />"))}function x(){for(var e="#",t=0;t<3;t++)e+=("0"+(256*Math.random()|0).toString(16)).substr(-2);return e}var F=a.createEnum([{name:"ALARM",value:"ALARM",label:s("Alarm")},{name:"EVENT",value:"EVENT",label:s("Event")}]),w={TIMELINE_TYPES:F,getSampleAlarmsAndEventsConfigsForDevice:o,getEmptyAlarmEventConfigForDevice:u,fetchTimelinesForAlarmsEvents:v,alarmMatchesConfig:y,eventMatchesConfig:E,transformAlarmToTimelineEvent:T,transformEventToTimelineEvent:C};return w}e.$inject=["$q","$compile","$rootScope","$filter","c8yBase","c8yAlarms","c8yEvents","gettext"],angular.module("c8y.alarmsEventsExplorer").factory("c8yAlarmsEventsTimelinesChartService",e)}(),function(){"use strict";function e(e,t,n,r,a,i){function l(){c.configs=c.configs||[]}function s(){a({templateUrl:"core_alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelineConfig.modal.html",controller:"c8yAlarmsEventsTimelineConfigModalController",controllerAs:"vm"}).then(function(e){c.configs=c.configs.concat(e)})}function o(e){_.pull(c.configs,e)}var c=this;_.assign(c,{$onInit:l,add:s,remove:o,timelineTypes:i.TIMELINE_TYPES.values()})}e.$inject=["$q","c8yBase","c8yAlarms","c8yEvents","c8yModal","c8yAlarmsEventsTimelinesChartService"],angular.module("c8y.alarmsEventsExplorer").component("c8yAlarmsEventsTimelinesConfig",{bindings:{configs:"="},templateUrl:"core_alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelinesConfig.html",controller:e,controllerAs:"vm"})}(),function(){"use strict";function e(e,t,n,r){function a(){i(),e.$watch("vm.selectedDevice",s)}function i(){var e=r.getContext();l(e)?m.rootId=e.id:m.noContext=!0}function l(e){var t=e.context;return t&&("device"===t||"group"===t)}function s(e){e&&(n.getSampleAlarmsAndEventsConfigsForDevice(e).then(function(e){m.suggestedAlarmsEventsConfigs=e}),m.customCfg=n.getEmptyAlarmEventConfigForDevice(e))}function o(){return _.filter(m.suggestedAlarmsEventsConfigs,{__active:!0}).concat(m.customCfg.__active?[m.customCfg]:[])}function c(){t.close(_.map(o(),function(e){return e.label||(e.label=e.filters.type),e}))}var m=this;_.assign(m,{$onInit:a,getSelected:o,add:c,cancel:t.dismiss,timelineTypes:n.TIMELINE_TYPES.values()})}e.$inject=["$scope","$uibModalInstance","c8yAlarmsEventsTimelinesChartService","c8yUiUtil"],angular.module("c8y.alarmsEventsExplorer").controller("c8yAlarmsEventsTimelineConfigModalController",e)}(),function(){"use strict";function e(e){var t;t='<c8y-timelines-chart date-from="vm.timeline.dateFrom" date-to="vm.timeline.dateTo" on-update-dates="vm.onUpdateDates($dateFrom, $dateTo)" timelines="vm.timeline.timelines" chart-box="vm.timeline.chartBox" on-size-changed="vm.onSizeChanged({$size: $size})">\r\n</c8y-timelines-chart>\r\n',e.put("core_alarmsEventsExplorer/alarmsEventsTimelinesChart/alarmsEventsTimelinesChart.html",t),e.put("/apps/core/alarmsEventsExplorer/alarmsEventsTimelinesChart/alarmsEventsTimelinesChart.html",t),t='<div class="modal-header">\r\n  <h3 translate>Add alarm / event</h3>\r\n</div>\r\n\r\n<div class="modal-body">\r\n  <div class="form">\r\n    <div class="form-group">\r\n      <label translate>Asset</label>\r\n      <c8y-device-selector-combo parent="vm.rootId" selected-child-device="vm.selectedDevice">\r\n      </c8y-device-selector-combo>\r\n    </div>\r\n  </div>\r\n\r\n  <div>\r\n    <div class="alert alert-info" ng-show="vm.loadingSuggestedAlarmsEventsConfigs">\r\n      <span>{{\'Loading alarms and events\' | translate}}&hellip;</span>\r\n    </div>\r\n\r\n    <div class="alert alert-info" ng-show="vm.suggestedAlarmsEventsConfigs.length" translate>\r\n      The following are recent alarms and events you may want to add:\r\n    </div>\r\n\r\n    <table class="table table-condensed data-point-list" ng-show="vm.selectedDevice">\r\n      <thead>\r\n        <tr>\r\n          <th></th>\r\n          <th></th>\r\n          <th translate>Device</th>\r\n          <th translate>Data type</th>\r\n          <th translate>Alarm / event type</th>\r\n        </tr>\r\n      </thead>\r\n\r\n      <tbody>\r\n        <tr ng-repeat="cfg in vm.suggestedAlarmsEventsConfigs">\r\n          <td class="text-center">\r\n            <input type="checkbox" ng-model="cfg.__active">\r\n          </td>\r\n          <td style="width: 30px" class="text-center">\r\n            <i c8y-icon="circle" ng-style="{color: cfg.color}"></i>\r\n          </td>\r\n          <td class="word-break">{{cfg.__target.name}}</td>\r\n          <td class="word-break">{{cfg.timelineType | translate}}</td>\r\n          <td class="word-break">{{cfg.filters.type}}</td>\r\n        </tr>\r\n        <tr>\r\n          <td class="text-center">\r\n            <input type="checkbox" ng-model="vm.customCfg.__active">\r\n          </td>\r\n          <td class="text-center colorpicker-column" style="width:20px">\r\n            <input c8y-color-picker name="color" type="text" class="colorpicker" ng-model="vm.customCfg.color" uib-tooltip="{{\'Change color\' | translate}}">\r\n            <i c8y-icon="circle" ng-style="{color: vm.customCfg.color}"></i>\r\n          </td>\r\n          <td class="word-break">{{vm.customCfg.__target.name}}</td>\r\n          <td class="text-center">\r\n            <select class="input-sm form-control" ng-options="tt.value as (tt.label | translate) for tt in vm.timelineTypes" ng-model="vm.customCfg.timelineType" ng-init="vm.customCfg.timelineType = vm.customCfg.timelineType || vm.timelineTypes[0].val" ng-required="vm.customCfg.__active">\r\n            </select>\r\n          </td>\r\n          <td class="text-center">\r\n            <input name="alarmEventType" ng-model="vm.customCfg.filters.type" class="input-sm form-control" ng-required="vm.customCfg.__active">\r\n          </td>\r\n        </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n\r\n<div class="modal-footer">\r\n  <button class="btn btn-primary" ng-click="vm.add()" ng-disabled="!vm.getSelected().length" translate>\r\n    Add\r\n  </button>\r\n  <button class="btn btn-default" ng-click="vm.cancel()" translate>Cancel</button>\r\n</div>\r\n',e.put("core_alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelineConfig.modal.html",t),e.put("/apps/core/alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelineConfig.modal.html",t),t='<div class="card">\r\n  <div class="card-header">\r\n    <span class="card-title h4" translate>Alarms / Events</span>\r\n  </div>\r\n  <hr>\r\n\r\n  <div class="c8y-data-point-list list-group" ng-form="forms.alarmsEventsTimelineForm">\r\n    <div class="c8y-data-point list-group-item flex-row collapsible" ng-repeat="cfg in vm.configs" ng-form="forms.alarmsEventsTimelineChildForm{{$index}}" ng-class="{\'expanded\': isCollapsed}">\r\n      <div class="list-item-actions">\r\n        <button type="button" title="{{\'Expand\' | translate}}" class="collapse-btn" ng-click="isCollapsed = !isCollapsed"><i c8y-icon="chevron-down"></i></button>\r\n\r\n\r\n        <span class="dropdown settings" is-open="isopen" uib-dropdown>\r\n          <button class="dropdown-toggle c8y-dropdown" uib-dropdown-toggle>\r\n            <i c8y-icon="ellipsis-v"></i>\r\n          </button>\r\n          <ul class="dropdown-menu dropdown-menu-right text-right" uib-dropdown-menu>\r\n            <li>\r\n              <a href="" ng-click="vm.remove(cfg)">\r\n                <i c8y-icon="trash"></i> {{\'Remove\' | translate}}\r\n              </a>\r\n            </li>\r\n          </ul>\r\n        </span>\r\n      </div>\r\n\r\n      <div class="list-item-switch">\r\n        <label class="c8y-switch">\r\n          <input name="active" type="checkbox" ng-model="cfg.__active">\r\n          <span></span>\r\n        </label>\r\n      </div>\r\n\r\n      <div class="list-item-colorpicker">\r\n        <input c8y-color-picker name="color" class="colorpicker" ng-model="cfg.color" type="hidden" uib-tooltip="{{\'Change color\' | translate}}">\r\n      </div>\r\n\r\n      <div class="list-item-body text-truncate" title="{{\'Show details\' | translate}}" ng-click="isCollapsed = !isCollapsed">\r\n        <span name="label">{{cfg.label}}</span>\r\n      </div>\r\n\r\n      <div uib-collapse="!isCollapsed">\r\n        <div class="data-point-details">\r\n          <div class="form-group">\r\n            <label translate>Label</label>\r\n            <input name="label" ng-model="cfg.label" ng-model-options="{debounce: 300}" class="input-sm form-control">\r\n          </div>\r\n          <div class="data-point-target" ng-if="!noAsset">\r\n            <label translate>Target</label>\r\n            <p>{{cfg.__target.name}}</p>\r\n          </div>\r\n          <div class="tight-grid">\r\n            <div class="form-group col-xs-6 col-sm-4">\r\n              <label translate>Data type</label>\r\n              <div class="c8y-select-wrapper">\r\n                <select class="input-sm form-control" ng-options="tt.value as (tt.label | translate) for tt in vm.timelineTypes" ng-model="cfg.timelineType" ng-init="cfg.timelineType = cfg.timelineType || vm.timelineTypes[0].val">\r\n                </select>\r\n              </div>\r\n            </div>\r\n\r\n            <div class="form-group col-xs-6 col-sm-8">\r\n              <label for="alarmEventType" translate>Alarm / event type</label>\r\n              <input id="alarmEventType" name="alarmEventType" ng-model="cfg.filters.type" ng-model-options="{debounce: 300}" class="input-sm form-control">\r\n            </div>\r\n\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div><!-- /.data-point -->\r\n  </div><!-- / .c8y-data-point-list -->\r\n  <div class="card-footer separator">\r\n    <a href="" class="btn btn-primary" ng-click="vm.add()">\r\n      <i c8y-icon="plus-circle"></i>\r\n      <translate>Add alarm / event</translate>\r\n    </a>\r\n  </div>\r\n</div><!-- card -->\r\n',e.put("core_alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelinesConfig.html",t),e.put("/apps/core/alarmsEventsExplorer/alarmsEventsTimelinesConfig/alarmsEventsTimelinesConfig.html",t)}angular.module("c8y.alarmsEventsExplorer").run(["$templateCache",e])}();