/* core_dashboard 8.21.0 2018-01-30T22:08:21+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
angular.module("lvl.services",[]),angular.module("lvl.services").factory("uuid",function(){var e={new:function(){function e(e){var n=(Math.random().toString(16)+"000000000").substr(2,8);return e?"-"+n.substr(0,4)+"-"+n.substr(4,4):n}return e()+e(!0)+e(!0)+e()},empty:function(){return"00000000-0000-0000-0000-000000000000"}};return e}),angular.module("lvl.directives.dragdrop",["lvl.services"]),angular.module("lvl.directives.dragdrop").directive("lvlDraggable",["$rootScope","uuid",function(e,n){return{restrict:"A",link:function(t,a){a.attr("draggable","true");var r=a.attr("id");r||(r=n.new(),a.attr("id",r)),a.on("dragstart",function(n){n.originalEvent.dataTransfer.setData("text",r),n.originalEvent.dataTransfer.effectAllowed="move",e.$emit("LVL-DRAG-START",r)}),a.on("dragend",function(n){e.$emit("LVL-DRAG-END")})}}}]),angular.module("lvl.directives.dragdrop").directive("lvlDropTarget",["$rootScope","$timeout","uuid",function(e,n,t){return{restrict:"A",scope:{onDrop:"&"},link:function(n,a){function r(e){var n=e.originalEvent,t=a.offset().left,r=a.width(),o=n.pageX;return o<=t+r/2}function o(){return d===i}var i,d=a.attr("id");d||(d=t.new(),a.attr("id",d)),a.addClass("droppable"),a.append('<div class="overlayDrop"></div>'),a.bind("dragover",function(e){return e.preventDefault&&e.preventDefault(),o()?void(e.originalEvent.dataTransfer.dropEffect="none"):(a.removeClass("leftDrop rightDrop"),r(e)?a.addClass("leftDrop"):a.addClass("rightDrop"),void(e.originalEvent.dataTransfer.dropEffect="move"))}),a.on("dragenter",function(e){return e.preventDefault(),o()?void(e.originalEvent.dataTransfer.dropEffect="none"):(a.addClass("lvl-over"),e.originalEvent.dataTransfer.dropEffect="move",void setTimeout(function(){a.one("dragleave",function(e){e.originalEvent.dataTransfer.dropEffect="none",a.removeClass("leftDrop rightDrop"),a.removeClass("lvl-over")})},100))}),a.on("dragend",function(){a.off("dragend"),$(".rightDrop, .leftDrop, .lvl-over").removeClass("rightDrop leftDrop lvl-over")}),a.bind("drop",function(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var t=angular.element(a[0]).scope().child.id,o=angular.element(document.getElementById(i)).scope().child.id,d=r(e);n.$apply(["onDrop({source:'",o,"', dest:'",t,"', before:",d,"})"].join(""))}),e.$on("LVL-DRAG-START",function(e,n){i=n})}}}]),function(){"use strict";function e(e,n){function t(e,n,t,a,r,o){function i(){n.getFlag("deprecated")&&a.addAction({text:o("Create dashboard"),priority:-1e3,action:function(){r.createDashboard()}})}function d(e){e.forEach(c)}function c(e){t.addTab({name:e.name,icon:e.icon,priority:_.isUndefined(e.priority)?1e4:e.priority,path:"/device/"+l+"/dashboard/"+e.id})}var l=e.deviceId;i(),r.list(l).then(d)}t.$inject=["$routeParams","c8yBase","c8yTabs","c8yActions","dashboardSvcOld","gettext"],e.addUrlAction({path:"/device/:deviceId",autoRun:!0,action:t}),n.when("/device/:deviceId/dashboard/:dashboardId",{name:"dashboard",templateUrl:"core_dashboard/views/dashboard.html",controller:"dashboardCtrl"})}e.$inject=["c8yActionsProvider","c8yViewsProvider"],angular.module("c8y.parts.dashboard",["lvl.directives.dragdrop"]).config(e)}(),angular.module("c8y.parts.dashboard").controller("dashboardNewCtrl",["$scope","$uibModalInstance","$route","$location","$routeParams","dashboardSvcOld","iconList","dashboardObj","info","imageWidgetSvc",function(e,n,t,a,r,o,i,d,c,l){"use strict";function s(){e.dashboard.id?a.path("/device/"+r.deviceId+"/dashboard/"+e.dashboard.id):a.path("/device/"+r.deviceId),h(),e.dashboard.isDuplicate&&u(e.dashboard)}function u(e,n){var t=e.children;_.forEach(t,function(e){_.forEach(e,function(e){n?l.decrementReferenceCount(e):l.incrementReferenceCount(e)})})}function p(){t.reload(),h()}function f(e){_.assign(d,e);var n=d.isNew?_.cloneDeep(d):d,t=n.standalone&&!n.self,a=n.isNew||t?s:p;delete n.isNew,delete n.isDuplicate,dashboardSvc.save(r.deviceId,n).then(a,p)}function h(){n.dismiss()}function v(){return d.isNew?"Create":"Save"}function m(){var e="Edit";return d.isNew&&(e="Create"),d.isDuplicate&&(e="Duplicate"),e+" dashboard"}e.saveDashboard=f,e.createOrSave=v,e.cancel=h,e.icons=i,e.dashboard=_.cloneDeep(d),e.title=m,e.beta=c.beta}]),function(){"use strict";function e(e,n,t,a,r,o,i,d,c,l,s,u,p,f){function h(t){return t?(e.config=t,void(e.rows=t.children||[])):void n.path("/device/"+T)}function v(){i.detail(T,A).then(h)}function m(e){return"col-lg-"+e.col}function g(){d.addAction({text:f("Add widget to dashboard"),action:i.addChild,showIfPermissions:{adminMOs:[T]},priority:2600}),d.addAction({text:f("Edit dashboard"),priority:2400,action:function(){i.editDashboard(e.config)},showIfPermissions:{adminMOs:[T]}}),d.addAction({text:f("Remove dashboard"),priority:2e3,showIfPermissions:{adminMOs:[T]},action:function(){var n=e.config;return a.when(y(n)).then(_.partial(i.remove,T,n)).then(_.partial(D,n,!0)).then(_.partial(w,T))}}),r.getFlag("deprecated")&&d.addAction({text:f("Duplicate dashboard"),showIfPermissions:{readMOs:[T],anyRole:["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"]},action:function(){i.duplicateDashboard(e.config)}}),b()}function b(){c.shouldShowSmartRules().then(function(t){if(u.has("smartRuleTemplatesSvc")&&t){var a="sendDashboardsViaEmail",r=u.get("smartRuleTemplatesSvc");r.mustBeAvailable(a).then(function(){d.addAction({text:f("Send dashboard via email"),priority:2100,action:["c8yUiUtil","c8yInventory","c8yBase","$q",function(t,r,o,i){var d=t.getContext(),c="report"===d.context?r.detail(d.id).then(o.getResData).then(_.partialRight(_.pick,["name","icon"])):i.when(_.pick(e.config,["name","icon"]));c.then(function(e){var t=u.get("smartRulesSvc"),r={config:{dashboard:e,url:n.absUrl(),subject:p.getString("Print screen of {{name}}",e)}};t.createInstanceWithUIByName(a,r)})}]})})}})}function y(e){var n={title:f("Are you sure?"),body:p.getString("Do you want to remove the dashboard named '{{name}}'?",e),status:"danger"};return o(n)}function w(e){return n.path("/device/"+e)}function D(e,n){var t=e.children;_.forEach(t,function(e){_.forEach(e,function(e){n?s.decrementReferenceCount(e):s.incrementReferenceCount(e)})})}function C(n){e.$broadcast("childRemove",n),i.removeChild(T,e.config,n)}function $(n,t,a){var r,o;e.rows.forEach(function(e){e.forEach(function(a){n===a.id&&(r=e,n=a),t===a.id&&(o=e,t=a)})}),o.splice(o.indexOf(t)+(a?0:1),0,_.cloneDeep(n)),r.splice(r.indexOf(n),1),e.rows=i.tidyRows(e.rows),i.save(T,e.config)}function E(){n.path("/device/"+T+"/kpi")}function S(n){e.hasKpiTab=n}function I(e){return(e||"").replace(/\/\//g,"/")}var T=t.deviceId,A=t.dashboardId;e.getClass=m,e.addChild=i.addChild,e.removeChild=C,e.editChild=i.editChild,e.dropped=$,e.openKpi=E,e.getTplUrl=I,v(),g(),l.hasSupportedMeasurements().then(S)}e.$inject=["$scope","$location","$routeParams","$q","c8yBase","c8yModal","dashboardSvcOld","c8yActions","c8yUiUtil","kpiSvc","imageWidgetSvc","$injector","gettextCatalog","gettext"],angular.module("c8y.parts.dashboard").controller("dashboardCtrl",e)}(),angular.module("c8y.parts.dashboard").controller("dashboardComponentCtrl",["$scope","$uibModalInstance","$route","$routeParams","dashboardSvcOld","c8yComponents","currentComponent","gettext","gettextCatalog",function(e,n,t,a,r,o,i,d,c){"use strict";function l(){v(),t.reload()}function s(e){S=e}function u(n){e.components=n,h()}function p(n,t){var a=(n||{}).name,r=(t||{}).name,o=c.getString((n||{}).nameDisplay||a),i=c.getString((t||{}).nameDisplay||r);e.title&&e.title!==i||(e.title=o)}function f(n){return e.components.filter(function(e){return e.name===n.name}).shift()}function h(){i&&(e.title=i.title,e.col=i.col,e.data.cmp=f(i),e.config=_.cloneDeep(i.config)||{})}function v(){n.dismiss()}function m(){r.detail(A,R).then(s)}function g(){o.list().then(u)}function b(e,n,t,a){var o,i=S.children||[];return i.forEach(function(e){var n=T;e.forEach(function(e){n-=e.col}),n>=t&&(o=e)}),o||(o=[],i.push(o)),o.push(_.assign(_.cloneDeep(e),{col:t||I,id:String(Math.random()).substr(2),title:n,config:a})),S.children=i,r.save(A,S)}function y(e,n,t,a,o){var i,d=S.children||[];return _.isUndefined(o.$row)||_.isUndefined(o.$col)?d.forEach(function(e){if(e.forEach(function(e){if(o===e)return i=e,!1}),i)return!1}):i=d[o.$row][o.$col],_.assign(i,_.cloneDeep(e)),_.assign(i,{col:parseInt(t||I,10),title:n,config:a}),S.children=r.tidyRows(d),r.save(A,S)}function w(e,n,t,a){var r,o=D(a);return r=i?y(e,n,t,o,i):b(e,n,t,o),r.then(l,l)}function D(e){var n=_.cloneDeep(e),t=n.device;return t&&(n.device={id:t.id,name:t.name}),n}function C(e){return!(e.options&&e.options.noNewWidgets)}function $(e){return e.nameDisplay||e.name}function E(e){return e.description||d("no description")}var S,I=3,T=12,A=a.deviceId||a.groupId,R=a.dashboardId,x=[];e.cancel=v,e.save=w,e.widths=x,e.config={},e.data={},e.currentComponent=i,e.$watch("data.cmp",p),e.col=6,e.rootId=A,e.noNewWidgets=C,e.orderWidgets=$,e.getItemDescription=E,m(),g()}]),function(){"use strict";function e(e,n,t,a,r,o){function i(e){var n=_.flattenDeep(e);return t.all(_.map(n,d)).then(function(){return n})}function d(e){var n=["templateUrl","configTemplateUrl"],a=_.flattenDeep(e.children),r=_.map(a,function(e){return t.all(_.map(n,_.partial(c,e)))});return t.all(r).then(function(){return e})}function c(e,n){var t=e[n];return o.verifyPluginViewPath(t).then(function(t){return e[n]=t,e})}function l(){p()}function s(e){p(e)}function u(e){var n=_.cloneDeep(e);n.id=String(Math.random()).substr(2),n.isNew=!0,n.isDuplicate=!0,p(n,!0)}function p(e){n.open({templateUrl:"core_dashboard/views/new.html",controller:"dashboardNewCtrl",resolve:{dashboardObj:function(){return e||{id:String(Math.random()).substr(2),isNew:!0,icon:"certificate",priority:0,children:[]}}}})}function f(e){var t=e||null,a=n.open({templateUrl:"core_dashboard/views/component.html",controller:"dashboardComponentCtrl",size:"lg",resolve:{currentComponent:function(){return t}}});return a.result}function h(e,n){return["dashboard",e,n].join("_")}function v(){return f()}function m(e,n,t){var a=e;return _.isUndefined(n)||_.isUndefined(t)||(a=_.cloneDeep(e),a.$row=n,a.$col=t),f(a)}function g(e){return a.detailCached(e).then(function(e){var n=h("type",e.data.type);return a.list({fragmentType:n})})}function b(e){var n=S.get(e);return n||(n=t.all([r.list("dashboard",e),g(e)]).then(i),S.put(e,n)),n}function y(e,n){var t=S.get("d"+n);return t||(t=b(e).then(function(e){return _.find(e,function(e){return n===e.id})}),S.put("d"+n,t)),t}function w(e,n){var t=null;return S.remove(e),n.id&&S.remove("d"+n.id),n.standalone?(n.self||(D(e,_.cloneDeep(n)),delete n.id),t=a.detailCached(e).then(function(e){var t=e.data,r=h("type",t.type);return n[r]={type:t.type},a.save(n)})):(n.self&&(a.remove(_.cloneDeep(n)),n.id=String(Math.random()).substr(2),delete n.lastUpdated,delete n.self,delete n.assetParents,delete n.childAssets,delete n.childDevices,delete n.deviceParents,delete n.owner,delete n.owner,_.keys(n).filter(function(e){return e.match(/dashboard_/)}).forEach(function(e){delete n[e]})),t=r.save("dashboard",e,n)),t}function D(e,n){var t;return S.remove(e),t=n.self?a.remove(n):r.remove("dashboard",e,n)}function C(e){var n=[];return e.forEach(function(e){e.forEach(function(e){n.push(e)})}),n}function $(e){var n,t=C(e),a=e;return a.length=0,t.forEach(function(e){var t=parseInt(e.col,10);n||(n=a[a.length]=[]);var r=_.reduce(n,function(e,n){var t=parseInt(n.col,10);return e+t},0);r+t>I&&(n=a[a.length]=[]),n.push(e)}),a}function E(e,n,t){var a=null,r=n.children;return r.forEach(function(o,i){return _.isArray(o)&&o.forEach(function(d,c){if(d===t)return o.splice(c,1),o.length||r.splice(i,1),a=w(e,n),!1}),!a}),r=$(r),a}var S=e("dashboardsOld"),I=12;return{list:b,save:w,remove:D,detail:y,addChild:v,removeChild:E,editChild:m,createDashboard:l,editDashboard:s,duplicateDashboard:u,tidyRows:$}}angular.module("c8y.parts.dashboard").factory("dashboardSvcOld",["$cacheFactory","$uibModal","$q","c8yInventory","uiConfig","c8yUiUtil",e])}(),function(){"use strict";function e(e){var n;n='<div class="modal-header">\n  <h3 ng-hide="currentComponent" translate>Add widget</h3>\n  <h3 ng-show="currentComponent" translate>Edit widget</h3>\n</div>\n<div class="modal-body" ng-init="forms = {}">\n  <form name="forms.componentForm">\n    <div class="form-group" style="position:relative; z-index:1000">\n      <label translate>Widget</label>\n\n      <ui-select ng-model="data.cmp">\n        <ui-select-match placeholder="{{\'Select widget\' | translate}}">\n          {{($select.selected.nameDisplay || $select.selected.name) | translate}}\n        </ui-select-match>\n        <ui-select-choices position="down" repeat="item in components | orderBy:orderWidgets | filter:noNewWidgets | filterByFields:$select.search:[\'name\',\'nameDisplay\',\'description\']">\n          <div>\n            <strong>{{(item.nameDisplay || item.name) | translate}}</strong>\n            <p>\n              <small class="text-muted">\n                {{getItemDescription(item) | translate}}\n              </small>\n            </p>\n          </div>\n        </ui-select-choices>\n      </ui-select>\n\n    </div>\n\n    <div class="form-group">\n      <label translate>Title</label>\n      <input class="form-control" ng-model="title" required>\n    </div>\n\n    <div class="form-group">\n      <label translate>Width</label>\n      <input type="range" min="{{data.cmp.minCol || 1}}" max="12" step="1" ng-model="col">\n      <p class="help-block" translate>{{col}} out of 12 columns</p>\n    </div>\n    <div class="form-group" ng-if="data.cmp && !data.cmp.options.noDeviceTarget">\n      <label translate>Child devices</label>\n      <c8y-device-selector-combo parent="rootId" selected-child-device="config.device" groups-selectable="data.cmp.options.groupsSelectable">\n      </c8y-device-selector-combo>\n    </div>\n\n    <div ng-include="data.cmp.configTemplateUrl">\n    </div>\n\n\n\n  </form>\n\n</div>\n\n<div class="modal-footer">\n  <button class="btn btn-primary" ng-click="save(data.cmp, title, col, config)" ng-disabled="forms.componentForm.$invalid" translate>\n    Save\n  </button>\n  <button class="btn btn-default" ng-click="cancel()" translate>Cancel</button>\n</div>\n',e.put("core_dashboard/views/component.html",n),e.put("/apps/core/dashboard/views/component.html",n),n='<div class="row" ng-show="rows.length == 0">\n  <div class="col-lg-12 alert alert-warning">\n    <button ng-click="addChild()" class="btn btn-primary pull-right" translate>Add widget</button>\n    <translate>Please add widgets to this dashboard.</translate>\n    <!-- <span ng-show="hasKpiTab">Before, you may need to define key performance indicators on <a href="" ng-click="openKpi()">KPI tab</a>.</span>\n    <span ng-show="!hasKpiTab">This device does not support key performance indicators.</span> -->\n  </div>\n</div>\n\n<div class="row" ng-repeat="($row, row) in rows">\n  <div ng-repeat="($col, child) in row" ng-class="getClass(child)">\n    <div class="panel panel-clean panel-dashboard-old" x-lvl-draggable="true" x-lvl-drop-target="true" x-on-drop="dropped(source, dest, before)" style="position:relative">\n      <div class="panel-heading draggableCursor">\n        <div class="dropdown pull-right showOnHover" style="position: relative; top: -4px" uib-dropdown>\n          <a href="" class="dropdown-toggle btn btn-link" uib-dropdown-toggle><i c8y-icon="cog"></i></a>\n          <ul class="dropdown-menu" uib-dropdown-menu>\n            <li><a href="" ng-click="removeChild(child)" translate>Remove</a></li>\n            <li><a href="" ng-click="editChild(child, $row, $col)" translate>Edit</a></li>\n          </ul>\n        </div>\n        {{child.title}}\n      </div>\n      <div class="panel-body" ng-include="getTplUrl(child.templateUrl)">\n      </div>\n    </div>\n  </div>\n</div>\n',e.put("core_dashboard/views/dashboard.html",n),e.put("/apps/core/dashboard/views/dashboard.html",n),n='<div class="modal-header">\n  <h3>{{title() | translate}}</h3>\n</div>\n\n<div class="modal-body">\n  <form name="newDashboard">\n\n    <div class="form-group">\n      <label translate>Dashboard name</label>\n      <input class="form-control" name="name" ng-model="dashboard.name" required>\n    </div>\n\n    <div class="form-group">\n      <label translate>Location in navigation</label>\n      <input type="number" class="form-control" name="priority" ng-model="dashboard.priority" ng-max="10000" ng-min="-10000" required>\n      <p class="help-block" translate>Higher the number, higher the position on the navigation. (10000 top, -10000 bottom)</p>\n    </div>\n\n    <div class="form-group">\n      <label translate>Icon</label>\n      <ui-select ng-model="dashboard.icon">\n        <ui-select-match placeholder="{{\'Select or search icon\' | translate}}">\n          <i c8y-icon="{{$select.selected}}"></i>\n          {{$select.selected}}\n        </ui-select-match>\n        <ui-select-choices repeat="item in icons | filter: $select.search">\n          <div>\n            <i c8y-icon="{{item}}"></i> {{item}}\n          </div>\n        </ui-select-choices>\n      </ui-select>\n    </div>\n\n    <div class="form-group" ng-show="beta">\n      <label translate>Single or multiple devices</label>\n      <div class="input-group">\n        <label class="checkbox-inline">\n          <input type="checkbox" ng-model="dashboard.standalone" name="standalone" translate> Apply to all devices of the same type\n        </label>\n      </div>\n    </div>\n\n  </form>\n\n</div>\n\n<div class="modal-footer">\n  <button class="btn btn-primary" ng-click="saveDashboard(dashboard)" ng-disabled="newDashboard.$invalid">{{createOrSave() | translate}}</button>\n  <button class="btn btn-default" ng-click="cancel()" translate>Cancel</button>\n</div>\n',e.put("core_dashboard/views/new.html",n),e.put("/apps/core/dashboard/views/new.html",n)}angular.module("c8y.parts.dashboard").run(["$templateCache",e])}();