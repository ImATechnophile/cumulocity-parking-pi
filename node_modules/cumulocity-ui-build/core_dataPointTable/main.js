/* core_dataPointTable 8.21.0 2018-01-30T22:08:23+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
!function(){"use strict";function t(t,e){t.add({name:"Data points table",nameDisplay:e("Data points table"),description:e("A table display of a collection of data points"),templateUrl:"core_dataPointTable/views/widget.html",configTemplateUrl:"core_dataPointTable/views/widgetConfig.html",options:{noDeviceTarget:!0,minCol:6}})}t.$inject=["c8yComponentsProvider","gettext"],angular.module("c8y.cockpit.dataPointTable",[]).config(t)}(),function(){"use strict";function t(t,e,a,n,i){function r(){l(),a(o)}function o(){var a=n.getFixedHeader(e),i=e.find(".datepicker-container");a.prepend(i),t.$watch("child.config.displayDateSelection",function(t){t?a.addClass("datepicker"):a.removeClass("datepicker")})}function l(){var e=t.child.config.interval;if(e&&e!==i.custom.id){var a=_.find(i.intervals,function(e){return e.id===t.child.config.interval})||{};a.qty&&(t.child.config.dateFrom=moment().subtract(a.qty,a.unit).toDate(),t.child.config.dateTo=moment().toDate())}}var d=this;r(),t.$watch("child.config.realtime",function(t){d.realtime=!!t}),t.$watch("child.config.datapoints",function(t){var e=_.uniqBy(_.filter(_.map(t,function(t){return(t.__target||{}).id}),_.identity));e.length?d.channel="/measurements/"+e.join(","):d.channel=""})}t.$inject=["$scope","$element","$timeout","c8yDataPoint","INTERVAL_CONSTANTS"],angular.module("c8y.cockpit.dataPointTable").controller("c8yDataPointTableWidgetCtrl",t)}(),function(){"use strict";function t(t,e,a,n,i,r,o,l){function d(){var t=e.tbody.selectAll("tr").data(e.legend,function(t){return[t.date,t.targetId].join(";")});return c(t),s(t),u(t),t}function c(t){var a=t.enter().append("tr").on("click",function(t){A(this,t.date,t.targetId)});a.append("td").classed("datetime",!0).call(function(t){t.append("strong").attr("class",G.DATE_LEGEND_CSS_CLASS).style("margin-right","2px"),t.append("span")}),a.append("td").classed("target",!0).style("display",e.displayTarget?"block":"none").text(function(t){return t.targetName});var n=a.selectAll("td.datapoint").data(e.localDatapoints,function(t){return t._id});n.enter().append("td").call(function(t){var e=function(e){var a=t.data()||[];return a=_.filter(a,_.identity),a[e]};return function(t){t.attr("class",function(t,a,n){return _(g(e(n),t,"FIELD")).pick(_.identity).keys().value().join(" ")}).attr("stw-datatable-tooltip",function(t,a,n){return v(e(n),t)}),t.append("strong").text(function(t,a,n){var i=e(n);return L(i,t,"min")?h(i,t).min:""}).attr("class",function(t,a,n){return _(g(e(n),t,"TEXT","min")).pick(_.identity).keys().value().join(" ")}),t.append("strong").text(function(t,a,n){var i=e(n);return L(i,t,"min")&&L(i,t,"max")?" ... ":""}).classed(G.VALUE_SEPARATOR_CSS_CLASS,!0),t.append("strong").text(function(t,a,n){var i=e(n);return L(i,t,"max")?h(i,t).max:""}).attr("class",function(t,a,n){return _(g(e(n),t,"TEXT","max")).pick(_.identity).keys().value().join(" ")})}}(a)).classed("datapoint",!0).classed(G.VALUE_CSS_CLASS,!0),n.exit().remove(),n.order()}function s(t){t.classed(G.SELECTED_CSS_CLASS,function(t){return!!e.selected&&(moment(e.selected.date).valueOf()===t.momentDate.valueOf()&&e.selected.target===t.targetId)});var a=t.select("td.datetime");a.attr("stw-datatable-tooltip",function(t){if(!t.isFirstNewDate)return W(t.date)}),a.select("strong").attr("class",function(t){var e=t.isFirstNewDate;return e?G.DATE_LEGEND_FIRST_CSS_CLASS:G.DATE_LEGEND_REST_CSS_CLASS}).text(function(t){var e=t.date;return W(e)}),a.select("span").attr("class",G.TIME_LEGEND_REST_CSS_CLASS).text(function(t){return q(t.date)})}function u(t){t.exit().remove()}function f(){e.legend=_.sortBy(_.uniqBy(e.legend,function(t){return""+t.date+t.targetId}),["momentDate","targetName"])}function p(t,e){var a=e[t.fragment];return t.__target.id===e.source.id&&a&&a[t.series]}function m(t){var e=t.label,a=t.unit||t.data&&t.data.series&&t.data.series.unit,n=t.renderType&&j[_.findIndex(j,function(e){return e.val===t.renderType})].text;return[e,a?[" [",a,"]"].join(""):"",n?[" (",o.getString(n),")"].join(""):""].join("")}function g(t,e,a,n){var i=n?h(t,e)[n]:h(t,e),r={},o=G["DANGER_"+a+"_CSS_CLASS"],l=G["WARNING_"+a+"_CSS_CLASS"];return r[o]=!1,r[l]=!1,T(i,e)?r[o]=!0:x(i,e)&&(r[l]=!0),r}function h(t,e){if(!b(t,e))return{};var a={},n=e.data.values,i=t.date;switch(e.renderType){case"area":a.min=n[i].min,a.max=n[i].max;break;case"min":a.min=n[i].min;break;case"max":a.max=n[i].max;break;default:a.min=n[i].min}return a}function v(t,e){var a=h(t,e);return T(a,e)?o.getString("Red range: {{min}} … {{max}}",{min:e.redRangeMin,max:e.redRangeMax}):x(a,e)?o.getString("Yellow range: {{min}} … {{max}}",{min:e.yellowRangeMin,max:e.yellowRangeMax}):void 0}function S(t){return _.findIndex(t.data.series,function(e){return e.type===t.fragment&&e.name===t.series})}function b(t,e){var a=t.date;return e.data&&e.data.values&&e.__target.id===t.targetId&&_.isObjectLike(e.data.values[a])&&_.isNumber(e.data.values[a].min)&&_.isNumber(e.data.values[a].max)}function y(t,e,a){return _.isObjectLike(t)?t.min>=e&&t.min<=a||t.max>=e&&t.max<=a:t>=e&&t<=a}function T(t,e){return y(t,e.redRangeMin,e.redRangeMax)}function x(t,e){return y(t,e.yellowRangeMin,e.yellowRangeMax)}function D(){var t=e.localDatapoints;return V().then(function(a){_.forEach(a,function(a,n){var i=t[n];i.data=_.cloneDeep(a);var r=S(i),o=_.cloneDeep(i.data.series);delete i.data.series,r>-1?(i.data.series=o[r],_.forOwn(i.data.values,function(t,a){_.isObjectLike(i.data.values[a][r])&&(e.legend.push({date:a,momentDate:moment(a),targetId:i.__target.id,targetName:i.__target.name}),P(i,a,r))})):_.forOwn(i.data.values,function(t,e){P(i,e)})})}).then(f).then(k).then(d).then(function(){I=!0,O=!1}).then(w)}function C(t){M.push(t),w()}function w(){if(!O){for(var t=M.shift();t;)E(t),t=M.shift();k(),d();var e=z();0===e&&X()}}function E(t){_.forEach(e.localDatapoints,function(a){if(p(a,t)){a.data=a.data||{values:{}},a.data.values[t.time]={min:t[a.fragment][a.series].value,max:t[a.fragment][a.series].value};var n=_.last(e.legend)&&t.time===_.last(e.legend).date&&a.__target.id===_.last(e.legend).targetId;n||(e.legend.push({date:t.time,momentDate:moment(t.time),targetId:a.__target.id,targetName:a.__target.name}),e.legend.length>B&&e.legend.shift())}})}function A(t,a,n){e.rowsSelectable&&(e.selected&&e.selected.target===n&&moment(e.selected.date).isSame(a)?e.selected={}:(e.selected={date:a,target:n},e.skipScroll=!0))}function L(t,e,a){return _.isNumber(h(t,e)[a])}function k(){for(var t=0;t<e.legend.length;t++)e.legend[t].isFirstNewDate=0===t||e.legend[t].date.substr(0,10)!==e.legend[t-1].date.substr(0,10)}function P(t,e,a){t.data.values[e]=_.isUndefined(a)?{}:t.data.values[e][a]}function R(){e.legend=[],e.firstNewDates=[],e.localDatapoints=[],d()}function N(){e.legend=[],e.firstNewDates=[],e.$watch("datapoints",function(t){R(),t=_.cloneDeep(t),e.localDatapoints=_.uniqBy(t,function(t){return t._id}),e.displayTarget=_.uniqBy(e.localDatapoints,function(t){return t.__target.id}).length>1,U()}),e.$watch("dateFrom",U),e.$watch("dateTo",U),e.$watch("aggregation",U),e.$watch("selected",function(){if(I){if(d(),e.skipScroll)return void(e.skipScroll=!1);var t=e.table.find("."+G.SELECTED_CSS_CLASS).get(0);t&&e.panel.animate({scrollTop:t.offsetTop-e.panel.height()/2},500)}})}function F(){a.cancel(F.timeout),F.timeout=a(function(){if(e.table&&e.fixedHeader){var t=e.table.find("tbody tr:first td"),a=e.fixedHeader.find("thead tr:first th"),n=90*(t.length+1);a.each(function(e,a){return $(a).width(t.eq(e).width())}),e.table.css("minWidth",n+"px"),e.fixedHeader.find(".data-point-table").css("minWidth",n+"px"),e.fixedHeader.find(".datepicker-container").css("minWidth","550px")}},1e3,!1)}var I,j=[{val:"min",text:r("Minimum")},{val:"max",text:r("Maximum")},{val:"area",text:r("Area")}],G={BLOCK_DISPLAY:"block-display",DANGER_FIELD_CSS_CLASS:"danger",DANGER_TEXT_CSS_CLASS:"text-danger",DATE_LEGEND_CSS_CLASS:"text-left",DATE_LEGEND_FIRST_CSS_CLASS:"text-left",DATE_LEGEND_REST_CSS_CLASS:"text-muted text-left",SELECTED_CSS_CLASS:"active",TIME_LEGEND_FIRST_CSS_CLASS:"text-muted text-right",TIME_LEGEND_REST_CSS_CLASS:"text-right",VALUE_CSS_CLASS:"text-center",VALUE_SEPARATOR_CSS_CLASS:"text-muted",WARNING_FIELD_CSS_CLASS:"warning",WARNING_TEXT_CSS_CLASS:"text-warning"},O=!1,M=[],B=500,H=_.throttle(D,100,{leading:!0,trailing:!1}),U=function(){I=!1,O=!0,H()},W=_.memoize(t("dateOnly"),_.identity),q=_.memoize(t("timeOnly"),_.identity);N(),_.assign(e,{getChartTypeTooltip:m,getFieldStyling:g,getFieldValue:h,onData:C,data:{},selected:e.selected||{}}),e.$watch(F);var V=l.latest(function(){var t=e.localDatapoints,a=e.dateFrom,r=e.dateTo,o=e.aggregation;return e.legend=[],e.firstNewDates=[],n.all(_.map(t,function(t){return i.loadSeriesData(t,a,r,o)}))}),X=_.throttle(function(){var t=e.table.height();e.panel.scrollTop(t-e.panel.height()+20)},500),z=function(){return e.table.outerHeight(!0)-e.panel.scrollTop()-e.panel.height()}}t.$inject=["$filter","$scope","$timeout","$q","c8yDataPoint","gettext","gettextCatalog","c8yBase"],angular.module("c8y.cockpit.dataPointTable").controller("c8yDataPointTableController",t)}(),function(){"use strict";function t(t,e){function a(a){function n(){o.scrollLeft(d.scrollLeft())}var i=a.parents(".card.card-dashboard").children(".card-header-actions");if(0!==i.length){var r=a.children().clone();r.find("tbody").remove();var o=e.getFixedHeader(a);o.css({overflow:"hidden"}),o.append(r),a.find("thead").css("display","none");var l=t(r),d=a.parents(".card-inner-scroll"),c=_.debounce(n,200);return d.on("scroll",c),function(t,e){t.$on("$destroy",function(){return d.off("scroll",c)}),t.fixedHeader=o,t.element=e,t.panel=e.parents("div.panel-body"),t.table=e.find("table"),t.tbody=d3.select(e.find("tbody").get(0)),l(t)}}}return{restrict:"E",scope:{datapoints:"=?",dateFrom:"=?",dateTo:"=?",aggregation:"=?",selected:"=?",rowsSelectable:"=?",onData:"=?"},controller:"c8yDataPointTableController",templateUrl:"core_dataPointTable/views/dataPointTable.html",compile:a}}t.$inject=["$compile","c8yDataPoint"],angular.module("c8y.cockpit.dataPointTable").directive("c8yDataPointTable",t)}(),function(){"use strict";function t(t,e){function a(a,n,i,r){return n=n?moment(n).subtract(1,"minute").startOf("minute"):n,i=i?moment(i).add(1,"minute").startOf("minute"):i,e.listSeries({dateFrom:n?n.format(t.dateFullFormat):n,dateTo:i?i.format(t.dateFullFormat):i,source:a.__target.id,aggregationType:r||void 0})}function n(t){var e=t.parents(".card.card-dashboard").children(".fixed-header");if(!e.length){e=$('<div class="fixed-header"></div>');var a=t.parents(".card.card-dashboard").children(".card-header-actions");e.insertAfter(a)}return e}var i={loadSeriesData:a,getFixedHeader:n};return i}t.$inject=["c8yBase","c8yMeasurements"],angular.module("c8y.cockpit.dataPointTable").factory("c8yDataPoint",t)}(),function(){"use strict";function t(t){function e(e,a){t.start(e,a)}function a(e,a){t.stop(e,a)}function n(e,a){return t.getStatus(e,a)}function i(i){function r(t,e){t&&u(f,t),e&&e!==t&&a(f,e)}function o(t,e){i.data({data:e})}function l(){a(f,i.channel)}function d(){n(f,i.channel)?a(f,i.channel):e(f,i.channel)}function c(t){i.channel&&t&&e(f,i.channel),t===!1&&n(f,i.channel)&&a(f,i.channel)}function s(){var e=t.getStatus(f,i.channel);return i.channel&&(i.state=e),void 0!==e?t.icon(e):t.icon(!1)}function u(a,r){t.addListener(a,r,"CREATE",o),!i.state&&!i.start||n(a,r)||e(a,r)}var f=i.$id;i.$watch("channel",r),i.$on("$destroy",l),i.icon=s,i.on=d,i.$watch("start",c)}return{scope:{start:"=",channel:"@",data:"&onData",subscribed:"&onSubscribed",state:"="},replace:!0,restrict:"EA",templateUrl:"core_dataPointTable/views/realtimeRadioButton.html",controller:["$scope",i]}}angular.module("c8y.cockpit.dataPointTable").directive("c8yRealtimeRadioButton",["c8yRealtime",t])}(),function(){"use strict";function t(t){var e;e='<div class="data-point-table">\n  <table class="table table-condensed table-striped table-vertical-middle table-fixed">\n    <thead class="headers">\n      <tr>\n        <th style="width: 121px">\n          <div translate class="header-cell">Date &amp; time</div>\n          <div>&nbsp;</div>\n        </th>\n        <th ng-show="displayTarget">\n          <div translate class="header-cell">Device</div>\n          <div>&nbsp;</div>\n        </th>\n        <th ng-repeat="datapoint in localDatapoints" uib-tooltip="{{getChartTypeTooltip(datapoint)}}" tooltip-append-to-body="true" class="header-cell text-center">\n          <div class="text-truncate">{{datapoint.label}}</div>\n          <div class="text-truncate text-muted">{{datapoint.unit || datapoint.data.series.unit || \'&nbsp;\'}}</div>\n        </th>\n      </tr>\n    </thead>\n    <tbody ng-click="selectDate()">\n    </tbody>\n  </table>\n</div>',t.put("core_dataPointTable/views/dataPointTable.html",e),t.put("/apps/core/dataPointTable/views/dataPointTable.html",e),e='<div style="display: block">\r\n  <span style="line-height: 20px">\r\n    {{\'Realtime\' | translate}}\r\n  </span>\r\n  <button type="radio" class="btn btn-xs btn-default text-muted" ng-click="on()" ng-disabled="!channel" ng-model="start" uib-btn-checkbox>\r\n  </button>\r\n</div>\r\n',t.put("core_dataPointTable/views/realtimeRadioButton.html",e),t.put("/apps/core/dataPointTable/views/realtimeRadioButton.html",e),e='<div ng-controller="c8yDataPointTableWidgetCtrl as ctrl" style="margin-bottom: 20px">\n  <c8y-realtime-button ng-show="false" channel="{{ctrl.channel}}" state="ctrl.realtime" on-data="onData($data)">\n  </c8y-realtime-button>\n  <div class="datepicker-container" ng-if="child.config.displayDateSelection">\n    <c8y-date-time-picker ng-model="child.config.dateFrom" class="form-group form-group-sm pull-left" style="margin: 0 30px 0 10px" placeholder="" show-weeks="false" show-spinners="false" append-to-body="true">\n    </c8y-date-time-picker>\n    <c8y-date-time-picker ng-model="child.config.dateTo" class="form-group form-group-sm pull-left" placeholder="" show-weeks="false" show-spinners="false" append-to-body="true">\n    </c8y-date-time-picker>\n  </div>\n  <c8y-data-point-table datapoints="child.config.datapoints" date-from="child.config.dateFrom" date-to="child.config.dateTo" aggregation="child.config.aggregation" on-data="onData" widget-id="child.id" rows-selectable="child.config.selectable" selected="child.config.selected">\n  </c8y-data-point-table>\n</div>\n',t.put("core_dataPointTable/views/widget.html",e),t.put("/apps/core/dataPointTable/views/widget.html",e),e='<div ng-controller="DataPointWidgetConfigCtrl" ng-init="disableLocalStorage = true">\r\n  <div class="data-point-explorer" ng-controller="c8yDataPointExplorerCtrl">\r\n    <div class="c8yGraphFill" style="height:340px; clear: both">\r\n      <c8y-chart datapoints="data.graphDataPoints" date-from="data.dateFrom" date-to="data.dateTo" realtime="data.realtime" aggregation="data.aggregation" show-time="true">\r\n      </c8y-chart>\r\n    </div>\r\n    <c8y-data-point-list datapoints="data.datapoints" allow-adding-data-points-from-context-mo-only="dashboard.deviceType && dashboard.deviceTypeValue" dont-save="true">\r\n    </c8y-data-point-list>\r\n\r\n    <label class="checkbox-inline" style="margin-top: 20px">\r\n      <input type="checkbox" ng-model="data.displayDateSelection">\r\n      <translate>Show date selection</translate>\r\n    </label>\r\n  </div>\r\n</div>\r\n',t.put("core_dataPointTable/views/widgetConfig.html",e),t.put("/apps/core/dataPointTable/views/widgetConfig.html",e)}angular.module("c8y.cockpit.dataPointTable").run(["$templateCache",t])}();