/* core_scada 8.21.0 2018-01-30T22:09:28+00:00 ab57d6f7e859+ (release/8.21.0) r8.21.0 */
!function(){"use strict";function e(e,n){e.add({name:"SCADA",description:n("Display a configurable SVG."),templateUrl:"core_scada/views/component.html",configTemplateUrl:"core_scada/views/componentConfig.html",transformConfigWithContext:["config","context","dashboard",function(e,n,i){return i.deviceType&&e.deviceIds&&(e.deviceIds=_.mapValues(e.deviceIds,_.constant(n.id))),e}],options:{groupsSelectable:!0}})}e.$inject=["c8yComponentsProvider","gettext"],angular.module("c8y.parts.scadaWidget",[]).config(e)}(),function(){"use strict";function e(e,n,i,t,a){function c(c,r,o,s){function d(){if(v=s.$viewValue,!v)return void s.$setValidity("c8y-scada-svg",!1);f=c.$new(!0),_.forEach(c.mapping,function(e,n){Object.defineProperty(f,n,{enumerable:!0,get:_.partial(l,n)})}),_.assign(f,{goToGroupDetails:u,goToDeviceDetails:g,getActiveAlarmsStatusClass:p,isReady:_.constant(!0)});var n=angular.element('<div ng-if="isReady()" style="width:100%;height:100%;transform: translateZ(0);"></div>'),i=$.parseHTML(v);$(i).is("svg")?(n.append($(i).filter("svg")),s.$setValidity("c8y-scada-svg",!0)):(n.html('<div class="alert-warning" translate style="padding: 20px;">'+a("Invalid SVG")+"</div>"),s.$setValidity("c8y-scada-svg",!1)),e(n)(f),r.html(""),r.append(n)}function l(e){var n=c.mapping[e],i=_.find(c.devices,function(n){return c.deviceIds[e]===n.id});return t.getValueForMapping(i,n)}function u(e){n.path("/group/"+e)}function g(e){n.path("/device/"+e)}function p(e){return _.toLower(i.getHighestSeverityFromAlarmsStatus(e))||"none"}var f,v;s.$render=d,c.$watch("mapping",d),c.$watch("deviceIds",d,!0)}return{require:"ngModel",restrict:"EA",link:c,scope:{mapping:"=",devices:"=",deviceIds:"="},replace:!1}}e.$inject=["$compile","$location","c8yAlarms","ScadaWidgetUtilSvc","gettext"],angular.module("c8y.parts.scadaWidget").directive("c8yScadaSvg",e)}(),function(){"use strict";function e(e,n,i,t){function a(a,c,r,o){function s(e){var n={};return _.each(e,function(e){n[e.placeholder]=e.config}),n}function d(e){var n=!1;return _.forEach(e,function(e,i){var t=!_.isNull(e);C[i]=!t,n=n||!t}),!n}function l(e){return _.map(e,function(e,n){return{placeholder:n,config:e}})}function u(){a.mappings=o.$viewValue}function g(e){e.config=null,w()}function p(e){f(e).then(function(n){e.config=n}).then(w)}function f(n){return e.openSelector({selectSingle:!0,managedObject:b(a.deviceIds[n.placeholder])})}function v(e){n.edit(e.config).then(function(n){e.config.config=n}).then(w)}function h(e){t.openFieldbusSelector({device:b(a.deviceIds[e.placeholder])}).then(function(n){e.config=n}).then(w)}function m(e){var n=b(a.deviceIds[e.placeholder]);return i.getValueForMapping(n,e.config)}function y(e){return i.humanizeMapping(e.config)}function b(e){return _.find(a.devices,{id:e})}function w(){o.$setViewValue(_.cloneDeep(a.mappings))}function I(e){e&&_.forEach(a.mappings,$)}function $(e){var n=a.deviceIds,i=a.devices,t=n[e.placeholder];t&&_.find(i,{id:t})||(n[e.placeholder]=(_.head(i)||{}).id)}var C={};o.$parsers.push(s),o.$validators["c8y-scada-mapping"]=d,o.$overrideModelOptions({allowInvalid:!0}),o.$formatters.push(l),o.$render=u,_.assign(a,{hasError:C,clearMapping:g,setMapping:p,editComputedProperty:v,setFieldbusMapping:h,propertyValueFor:m,humanizeValue:y}),a.$watch("devices",I,!0)}return{require:"ngModel",restrict:"EA",link:a,templateUrl:"core_scada/views/mapping.html",scope:{device:"=",devices:"=",deviceIds:"=",onDeviceIdsChange:"&"}}}e.$inject=["SchemaPropertiesSvc","c8yComputedProperties","ScadaWidgetUtilSvc","c8yDeviceDatabase"],angular.module("c8y.parts.scadaWidget").directive("c8yScadaMapping",e)}();var _slicedToArray=function(){function e(e,n){var i=[],t=!0,a=!1,c=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done)&&(i.push(r.value),!n||i.length!==n);t=!0);}catch(e){a=!0,c=e}finally{try{!t&&o.return&&o.return()}finally{if(a)throw c}}return i}return function(n,i){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return e(n,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(){"use strict";function e(e,n,i,t,a,c,r,o,s){function d(e){I.svgFile={name:e.name};var n;return n=e instanceof Blob?a.readDataUri(e):a.downloadAsDataUri(e),n.then(a.decodeDataUri).then(l)}function l(e){return I.svgFile.data=e,p(),e}function u(n){_.forOwn(e.config.mapping,function(i,t){(1===I.devices.length||n)&&(e.config.deviceIds[t]=e.config.device.id),e.config.deviceIds[t]=e.config.deviceIds[t]||e.config.device.id})}function g(e){return _.find(I.devices,function(n){return e===n.id})}function p(){if(I.svgFile){var n=e.config.mapping||{},i=e.config.deviceIds||{},t=e.config.device&&e.config.device.id;e.config.mapping={},e.config.deviceIds={},_.forEach(v(I.svgFile.data),function(a){e.config.mapping[a]=n[a]?n[a]:null,e.config.deviceIds[a]=i[a]?i[a]:t||null}),f(e.config.deviceIds,e.config.mapping)}}function f(e,n){e&&n&&_.forOwn(e,function(e,i){var t=g(e),a=o.generatePaths(t);s.list().then(function(e){var t=_.sortBy(e,function(e){return e.keyPath.length}).reverse();null===n[i]&&(_.forEach(t,function(e){_.last(e.keyPath).toUpperCase()===i.toUpperCase()&&(n[i]=e)}),_.forEach(a,function(e){_.last(e).toUpperCase()===i.toUpperCase()&&(n[i]=o.createProperty(e))}))})})}function v(e){for(var n=[],i=/{{\s*([$\w]+?)\s*}}/g,t=i.exec(e);null!==t;)n.push(t[1]),t=i.exec(e);return n}function h(){return e.config.binaryId?(I.loading=!0,a.detail(e.config.binaryId).then(function(e){I.binaryFile=e.data,d(I.binaryFile),I.loading=!1})):n.when()}function m(e,n){I.device&&I.device.id!==n.id||_.assign(I.device,n)}function y(){var n=b(e.config.deviceIds);n!==$&&($.length&&c.stop(e.$id,"/managedobjects/"+$),n.length&&(c.addListener(e.$id,"/managedobjects/"+n,"UPDATE",m),c.start(e.$id,"/managedobjects/"+n),e.$on("$destroy",_.partial(c.stop,e.$id,"/managedobjects/"+n))),$=n)}function b(e){return _(e).values().uniq().value().sort(function(e,n){return e-n}).join(",")}function w(){I.binaryFile={},e.config.mapping=e.config.mapping||{},e.config.deviceIds=e.config.deviceIds||{},e.config.devices&&delete e.config.devices,h(),y()}var I=this,$="",C={c8y_Global:{}};this.deviceDetail=function(a,c){var r=!_.isEqual(a,c);a&&t.detail(a.id).then(function(a){I.device=a.data;var c=_.union([I.device.id],_.map(_.union(I.device.childAssets.references,I.device.childDevices.references),function(e){return e.managedObject.id}));_.remove(c,_.isUndefined),n.all(_.map(c,function(e){return t.detail(e)})).then(function(n){I.devices=_.map(n,function(e){var n=e.data;return _.assign({},n,{name:i("truncate")(n.name)})}),u(r),I.updateComputedProperties(e.config.deviceIds,e.config.mapping)})})},this.onSelectFile=function(n){var i=_slicedToArray(n.target.files,1),t=i[0];I.loading=!0,a.upload(t,C).then(function(n){I.binaryFile=n.data,e.config.binaryId=n.data.id,d(t),e.forms.componentForm.$setDirty()}).finally(function(){I.loading=!1})},this.updateComputedProperties=function(e,n){_.isEmpty(e)||_.isEmpty(n)||_.forOwn(e,function(e,i){var t=[n[i]];if(n[i]){var a=g(e);r.attach(a,_.filter(t,function(e){return _.isObjectLike(e)}))}})},this.onMappingChange=function(){I.updateComputedProperties(e.config.deviceIds,e.config.mapping)},this.onDeviceIdsChange=function(){I.updateComputedProperties(e.config.deviceIds,e.config.mapping),y()},w(),e.$watch("config.device",this.deviceDetail,!0),e.$watch("config.mapping",this.onMappingChange,!0),e.$on("$destroy",function(){_.forEach(e.config.deviceIds,function(e){r.detach(g(e))})})}e.$inject=["$scope","$q","$filter","c8yDevices","c8yBinary","c8yRealtime","c8yComputedProperties","fieldbusPropertyGenerator","c8yPropertiesLibrary"],angular.module("c8y.parts.scadaWidget").controller("ScadaWidgetConfigCtrl",e)}(),function(){"use strict";function e(e,n,i,t,a,c){function r(e){return _.find(o.devices,function(n){return e===n.id})}var o=this;this.init=function(){e.child.config.deviceIds||(e.child.config.deviceIds={},_.forOwn(e.child.config.mapping,function(n,i){e.child.config.deviceIds[i]=e.child.config.device.id}));var c=_(e.child.config.deviceIds).values().uniq().map(function(n){return a.detailRealtime(n,e,function(e){e.name=i("truncate")(e.name)})}).value();n.all(c).then(function(n){o.devices=n,o.updateComputedProperties(e.child.config.deviceIds,e.child.config.mapping)}),t.detail(e.child.config.binaryId).then(function(e){o.svgFile=e.data,t.downloadAsDataUri(o.svgFile).then(t.decodeDataUri).then(function(e){o.svgFile.data=e})})},this.updateComputedProperties=function(e,n){e&&n&&_.forOwn(e,function(e,i){var t=[n[i]];t.length&&c.attach(r(e),t)})},e.$watch("child.config",this.init,!0),e.$on("$destroy",function(){var n=_.uniq(_.values(e.child.config.deviceIds));_.forEach(n,function(e){c.detach(r(e))})})}e.$inject=["$scope","$q","$filter","c8yBinary","c8yDevices","c8yComputedProperties"],angular.module("c8y.parts.scadaWidget").controller("ScadaWidgetCtrl",e)}(),function(){"use strict";function e(e,a){var c=[new t(e,a),new n,new i];this.humanizeMapping=function(e){return null==e?"":this.getHandler(e).humanize(e)},this.getValueForMapping=function(e,n){return null==n?"":this.getHandler(n).getValue(e,n)},this.getRawValueForMapping=function(e,n){return null==n?"":this.getHandler(n).getRawValue(e,n)},this.getHandler=function(e){var n=_.find(c,function(n){return n.isGood(e)});if(null==n)throw new Error("invalid mapping");return n}}function n(){this.isGood=function(e){return _.isObjectLike(e)&&e.id&&e.keyPath&&_.isArray(e.keyPath)&&0!==e.keyPath.length},this.humanize=function(e){return e.label},this.getValue=function(e,n){return a(e,n.keyPath)},this.getRawValue=this.getValue}function i(){this.isGood=function(e){return _.isString(e)&&0!==e.length},this.humanize=function(e){return['"',e,'"'].join("")},this.getValue=function(e,n){return n},this.getRawValue=this.getValue}function t(e,n){function i(n){return n?(n.hasOwnProperty("__fieldbusDeviceType")||(Object.defineProperty(n,"__fieldbusDeviceType",{configurable:!0,writable:!0,value:!1}),e.getDeviceTypeFromDevice(n).then(e.addDiscreteIOsMeta).then(e.addRegistersMeta).then(function(e){n.__fieldbusDeviceType=e})),n):""}function t(e,i,t){if(!e.__fieldbusDeviceType)return a(e,i.keyPath);var c,r=_.head(i.keyPath);if("c8y_CoilStatus"===r?c=_.find(e.__fieldbusDeviceType.c8y_Coils,{name:_.last(i.keyPath)}):"c8y_RegisterStatus"===r&&(c=_.find(e.__fieldbusDeviceType.c8y_Registers,{name:_.last(i.keyPath)})),!c)return a(e,i.keyPath);var o=t?n.getCurrentElementValueFormatted:n.getCurrentElementValue;return o(e,c)}this.isGood=function(e){return _.isObjectLike(e)&&e.id&&e.keyPath&&_.isArray(e.keyPath)&&0!==e.keyPath.length&&e.fieldbus===!0},this.humanize=function(e){return e.label},this.getValue=function(e,n){return e=i(e),t(e,n,!0)},this.getRawValue=function(e,n){return e=i(e),t(e,n,!1)}}function a(e,n){for(var i=0;i<n.length&&(null!==e&&void 0!==e);i++)e=e[n[i]];return e}angular.module("c8y.parts.scadaWidget").service("ScadaWidgetUtilSvc",["c8yDeviceDatabase","c8yModbusDevice",e])}(),function(){"use strict";function e(e){var n;n='<div ng-controller="ScadaWidgetCtrl as ctrl" style="height: 100%">\n  <div c8y-scada-svg ng-model="ctrl.svgFile.data" mapping="child.config.mapping" device="child.config.device" devices="ctrl.devices" device-ids="child.config.deviceIds" style="height:100%"></div>\n</div>\n',e.put("core_scada/views/component.html",n),e.put("/apps/core/scada/views/component.html",n),n='<div ng-controller="ScadaWidgetConfigCtrl as ctrl">\n  <div class="form-group">\n    <label translate>SVG</label>\n    <button class="btn btn-link" ng-click="svgTooltipVisible = !svgTooltipVisible" uib-tooltip="{{\'Toggle help text\' | translate}}">\n      <i c8y-icon="question-circle-o" ng-class="{\'text-primary\': !svgTooltipVisible, \'text-muted\': svgTooltipVisible}"></i>\n    </button>\n    <div class="alert alert-info text-left" ng-show="svgTooltipVisible">\n      <p translate>\n        For placeholder to be recognized it needs to be used at least once\n        in curly braces with no other expression, e.g. <var ng-non-bindable>{{placeholderName}}</var>.\n        Then you can use this placeholderName in bindings handled by Angular.\n        There are also predefined functions available:\n      </p>\n      <ul>\n        <li>\n          <var ng-non-bindable>goToGroupDetails(groupId)</var> &ndash;\n          <translate>takes group\'s id and redirects user to group details view, e.g.</translate><br>\n          <var ng-non-bindable>&lt;... ng-click="goToGroupDetails(groupId)"&gt;</var>,\n        </li>\n        <li>\n          <var ng-non-bindable>goToDeviceDetails(deviceId)</var> &ndash;\n          <translate>takes device\'s id and redirects user to device details view, e.g.</translate><br>\n          <var ng-non-bindable>&lt;... ng-click="goToDeviceDetails(deviceId)"&gt;</var>,\n        </li>\n        <li>\n          <var ng-non-bindable>getActiveAlarmsStatusClass(alarmsStatus)</var> &ndash;\n          <translate>takes alarms status object and returns a CSS class that can be used for styling: none, warning, minor, major, critical, e.g.</translate><br>\n          <var ng-non-bindable>&lt;... ng-class="getActiveAlarmsStatusClass(alarmsStatus)"&gt;</var>.\n        </li>\n      </ul>\n    </div>\n    <input class="form-control" type="text" name="svg-name" ng-model="ctrl.svgFile.name" ng-required="true" ng-readonly="true"/>\n    <div>\n      <input class="form-control" type="file" name="svg-file" accept=".svg" c8y-on-change="ctrl.onSelectFile(event)" style="height: initial"/>\n    </div>\n  </div>\n\n  <div class="form-group">\n    <label>{{\'Preview\' | translate}}</label>\n    <span ng-show="ctrl.loading" style="margin-left: 5px">\n      <i c8y-icon="spinner" class="fa-spin"></i>\n    </span>\n    <div ng-switch="!!(ctrl.device && forms.componentForm.mapping.$valid && config.mapping)">\n      <div ng-switch-when="true" c8y-scada-svg ng-model="ctrl.svgFile.data" mapping="config.mapping" device="ctrl.device" devices="ctrl.devices" device-ids="config.deviceIds" style="height:200px"></div>\n      <div ng-switch-default class="alert-warning" style="padding: 5px" translate>You need to choose a device and fill all mappings to be able to preview an SVG.</div>\n    </div>\n  </div>\n\n  <div c8y-scada-mapping name="mapping" ng-model="config.mapping" device="ctrl.device" devices="ctrl.devices" device-ids="config.deviceIds" on-device-ids-change="ctrl.onDeviceIdsChange()">\n  </div>\n</div>\n',e.put("core_scada/views/componentConfig.html",n),e.put("/apps/core/scada/views/componentConfig.html",n),n='<table class="table">\n  <thead>\n    <tr>\n      <th>\n        <label translate>Placeholder</label>\n      </th>\n      <th>\n        <label translate>Target</label>\n      </th>\n      <th>\n        <label translate>Mapped to</label>\n      </th>\n      <th>\n        <label translate>Current value</label>\n      </th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="mapping in mappings | orderBy:\'placeholder\'" class="property" ng-class="{ danger: hasError[mapping.placeholder] }">\n      <td>\n        {{mapping.placeholder}}\n      </td>\n      <td>\n        <span ng-show="devices.length == 1">\n          {{devices[0].name}}\n        </span>\n        <select ng-show="devices.length > 1" ng-options="device.id as device.name for device in devices" ng-model="deviceIds[mapping.placeholder]" ng-change="onDeviceIdsChange()" required>\n        </select>\n      </td>\n      <td ng-switch="!!mapping.config.configSchema">\n        <a ng-switch-when="true" class="btn btn-xs btn-default" href ng-click="editComputedProperty(mapping)">\n          <i c8y-icon="bolt"></i> {{humanizeValue(mapping)}}\n        </a>\n        <span ng-switch-default>{{humanizeValue(mapping)}}</span>\n      </td>\n      <td class="word-break">\n        {{propertyValueFor(mapping)}}\n      </td>\n      <td style="width:15%">\n        <button type="button" class="btn btn-danger btn-xs showOnHover pull-right" title="{{\'Clear mapping\' | translate}}" ng-click="clearMapping(mapping)">\n          <i c8y-icon="scissors"></i>\n        </button>\n        <button type="button" class="btn btn-primary btn-xs showOnHover pull-right" title="{{\'Assign fieldbus property\' | translate}}" ng-click="setFieldbusMapping(mapping)">\n          <i c8y-icon="tasks"></i>\n        </button>\n        <button type="button" class="btn btn-primary btn-xs showOnHover pull-right" title="{{\'Assign device property\' | translate}}" ng-click="setMapping(mapping)">\n          <i c8y-icon="pencil"></i>\n        </button>\n      </td>\n    </tr>\n  </tbody>\n</table>\n',e.put("core_scada/views/mapping.html",n),e.put("/apps/core/scada/views/mapping.html",n)}angular.module("c8y.parts.scadaWidget").run(["$templateCache",e])}();